---
layout: index
title: 리눅스 컨테이너 기술에 대한 기초 요약
nav_order: 12
parent: Linux
permalink: /Linux11

작성일자: 2022/12/01
### Kernel

Linux 운영 체제(OS)의 주요 구성 요소이자 컴퓨터 하드웨어와 프로세스를 잇는 핵심 인터페이스

커널의 기능

1. 메모리 관리 - 메모리가 어디서 무엇을 저장하는데 얼마나 사용되는지를 추적함
2. 프로세스 관리 - 어느 프로세스가 중앙 처리 장치(CPU)를 언제 얼마나 오랫동안 사용할지 결정
3. 장치 드라이버 - 하드웨어, 프로세스 사이에서 중재자/interpreter 역할을 함
4. 시스템 호출 및 보안 - 프로세스의 서비스 요청을 수신합니다

커널은 사용자가 볼 수 없고, 커널 공간이라는 자신만의 작업 공간에서 메모리를 할당하고 저장되는 모든 항목을 추적한다. -> 한 가운데서 메모리에 상주하며 CPU에 명령을 내리는 소프트웨어

웹 브라우저 및 파일과 같이 사용자가 볼 수 있는 것을 사용자 공간이라고 한다. 이런 어플리케이션은 시스템 호출 인터페이스(SCI)를 통해 커널과 통신한다.



#### OS 내에서 커널의 위치

1. 하드웨어 - 메모리, 프로세서 or 중앙 처리 장치(CPU) 그리고 입출력(I/O) 장치(스토리지, 네트워킹, 그래픽)
2. Linux 커널 - 메모리에 상주하며 CPU에 명령
3. user process - 실행중인 프로그램으로 커널이 관리함, 커널은 이러한 프로세스 및 서버가 서로 통신하게 해줌

시스템에서 실행되는 코드는 커널 모드, 사용자 모드가 있는데,

커널 모드에서 실행할 때는 하드웨어에 무제한 액세스가 가능, 사용자 모드에선 CPU 및 메모리가 SCI를 통해 액세스 하는 것을 제한한다. 때문에 이 구분점이 보안, 컨테이너 구축, 가상 머신을 위한 권한과 같은 복잡한 작업의 토대가 된다.

 

### 리눅스 컨테이너

운영체제 수준의 가상화 기술로 리눅스 커널을 공유하며 프로세스를 격리된 환경에서 실행하는 기술이다. 컨테이너로 실행된 프로세스는 커널을 공유하지만, 리눅스 네임스페이스, 컨트롤 그룹, 루트 디렉터리 격리 등의 커널 기능을 활용해 격리되어 실행된다. 이러한 격리 기술 덕분에 호스트 머신에겐 프로세스로 인식되지만, 컨테이너 관점에선 독립적인 환경을 가진 가상머신처럼 보인다.



### 시스템 컨테이너와 어플리케이션 컨테이너

#### 시스템 컨테이너

일반적인 리눅스처럼 init 프로세스 등을 사용해 다수의 프로세스가 같은 환경을 공유한다. 이를 지향하는 컨테이너 런타임으로 LXC와 LXD가 있다. (LXD는 LXC(Linux Container)의 강화된 버전)

#### 애플리케이션 컨테이너

시스템 컨테이너와 다르게 컨테이너 기술을 활용해 하나의 어플리케이션(프로세스)를 실행하는 것을 목표로 한다. 대표적인 런타임으로 도커가 있다.

#### 컨테이너 런타임이란?

컨테이너를 실행하고 관리하는 도구다

#### CRIO-O

cri-o는 쿠버네티스를 위한 경량 컨테이너 런타임 프로젝트로 K8s CRI(kubernetes Container Runtime Interface)가 cri-o의 표준을 따라 구현하고 있다.

#### 도커

애플리케이션 컨테이너 런타임을 지향하며 containerd와 runc를 기반으로 동작한다. 유니온 마운트 기반으로 효율적으로 실행 환경을 **이미지**로 만들고 공유할 수 있는게 장점이다(공유는 docker hub를 통해). 도커는 서버, 클라이언트 아키텍쳐를 가지고 있으며 Rest API로 조작할 수 있다. 

#### Union Mount란

파일 시스템 병합과 병합 마운트

- 일반적으로 리눅스에선 디렉토리 하나에 하나의 파일 시스템만 마운트한다. 동일 디렉토리에 둘 이상의 파일 시스템을 마운트하면 항상 마지막에 마운트한 파일시스템 내용만 보이고, 이전에 마운트한 파일 시스템의 내용은 접근이 불가능하다.

- 병합 마운트란 하나의 디렉토리에 여러 파일 시스템을 마운트하면 여러 파일 시스템 내용이 합쳐지는 것을 의미한다. 먼저 마운트한 파일 시스템의 디렉토리 구조는 나중에 마운트한 파일 시스템의 디렉토리 구조와 합쳐진다.

- 이 때 동일한 파일이 있으면 나중에 마운트된 파일로 덮어쓴다.

- 유니온 마운트가 도커에 어떻게 적용되는지 구체적으로 알아보자

  도커의 이미지는 Union File System의 CoW(Copy on Write) 전략을 사용한다.
  이는 기존 레이어(하위) 위에 새로운 레이어(상위 레이어)가 쌓일 경우, 하위 레이어는 읽기 전용 상태가 되는 것이다. 상위 레이어에서 하위 레이어에 쓰기 작업을 수행할 때, 하위 레이어를 복사하여 사용하기 때문에 상위 레이어는 하위 레이어에 아무런 영향을 주지 않는다.

  이를 통해 서로 독립적인 파일 시스템 운용이 가능해진다.

* 도커에서 관리되는 모든 레이어와 관련 정보는 호스트의 파일 시스템 내의 /var/lib/docker 폴더에 저장되며 이를 Docker area 혹은 Backing Filesystem 이라고 부른다.



### 컨테이너 오케스트레이션

다수의 컨테이너를 적절하게 분산하고 스케줄링하는 방법과 도구이다. 대표적으로 쿠버네티스가 있다.



### 컨테이너에서 사용하는 프로세스 격리 기능



#### 리눅스 네임스페이스(Linux Namespace)

 리눅스 네임스페이스는 **특정 프로세스의 리눅스 리소스 접근을 제어**하기 위해 사용되는 기능이다.

네임스페이스는 리소스 별로 IPC namespace, Mount namespace, Network namespace, PID namespace, User namespace, UTS namespace, Control namespace 등으로 나뉜다. 시스템 상에서 실행되는 프로세스들은기본적으로 init 프로세스의 네임스페이스를 공유하지만, 시스템콜, unshare 명령어를 사용해 리소스 별로 namespace를 분ㄹ리하는 것이 가능하다.



##### PID namespace

프로세스 ID를 격리할 수 있는 namespace이다. 프로세스 ID를 격리해서 컨테이너가 init프로세스인 것처럼 실행해준다.

##### Network namespace

프로세스 별로 고유한 네트워크 환경을 구축할 수 있도록 도와준다. 프로세스에 전용 IP를 할당하거나 네트워크 인터페이스를 추가하고 설정할 수 있다. 네트워크 네임스페이스는 ip 명령어로 조작할 수 있다.

##### UTS namespace

호스트 네임과 NIS 도메인 이름을 격리하는 namespace로 Network namespace와 같이 사용되는 경우가 많다.

##### 루트 디렉터리 격리와 chroot

컨테이너는 호스트의 파일 시스템이 아닌 별도의 실행 환경을 갖는다. 이 때 루트 디렉터리 격리 기술로 chroot, pivot_root와 같은 시스템 콜을 사용한다. 이를 통해 프로세스가 바라보는 root directory를 파일 시스템 상의 특정한 디렉토리로 변경하는 것이 가능하다.

##### 컨트롤그룹(cgropus)

프로세스에서 사용 가능한 CPU, 메모리, 네트워크 대역폭, 디스크 I/O 등을 그룹 단위로 제어하는 리눅스 커널 기능이다. 컨트롤 그룹은 컨테이너에서 뿐만 아니라 리눅스 시스템에서 프로세스 관리를 위해 일반적으로 사용된다.

#### Linux Capabilities

프로세스의 권한을 제어하는 기능이다. 리눅스의 프로세스는 크게 루트 권한(UserId=0)으로 실행되는 특권 프로세스(previliged)와 일반 사용자가 실행하는 비특권 프로세스로 나뉜다. 루트와 권한을 세분화해서 프로세스 적용할 수 있도록 만든 기능이 바로 linux capabilities. 컨테이너 런타임에서도 일부 루트 권한이 필요한 경우, linux capabilities를 사용해 필요한 권한을 지정하는 방식을 지원한다.

(previleged option을 말하는 것 같다)



### 컨테이너 이미지에 관하여

이미지는 컨테이너가 실행되는 파일 시스템이다. 이 때 사용되는 핵심기능은 위에서 나온 chroot를 통해 루트 디렉토리를 변경하는 작업이다. 이미지는 러프하게 컨테이너가 바라보는 새로운 루트 디렉터리라고 할 수 있다. 컨테이너 런타임의 프로세스 격리 기술과 chroot를 함께 사용하면 docker가 아니더라도 다른 리눅스 버전의 컨테이너를 구현할 수 있다.





### 출처

container 기본 개념 관련 출처

* https://www.44bits.io/ko/keyword/linux-container

Union Mount 관련 출처

* https://lethean.github.io/2009/01/09/linux-union-mount/

* https://velog.io/@koo8624/Docker-%EC%9C%A0%EB%8B%88%EC%98%A8-%ED%8C%8C%EC%9D%BC-%EC%8B%9C%EC%8A%A4%ED%85%9C-Union-File-System

파일 시스템 관련 출처

https://lilo.tistory.com/17

